<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>캐릭터 생성 - Raid Starter Kit</title>
  <link rel="stylesheet" href="../styles/base.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="row" style="justify-content: space-between;">
        <div>
          <h1 style="margin: 0; font-size: 24px;">👤 캐릭터 생성</h1>
        </div>
        <div class="row">
          <a href="roster.html" class="btn">로스터</a>
          <a href="lobby.html" class="btn">로비</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container grid" style="grid-template-columns: 1fr 400px;">
    <section class="card">
      <h3>캐릭터 정보</h3>
      
      <!-- 이미지 업로드 -->
      <div class="row" style="margin-bottom: 16px;">
        <div style="width: 200px; height: 200px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: grid; place-items: center; background: #f6f6f6;">
          <img id="preview" style="max-width: 100%; max-height: 100%; display: none;">
          <div id="placeholder" style="color: var(--muted);">이미지 미리보기</div>
        </div>
        <div style="flex: 1; margin-left: 16px;">
          <input id="file" type="file" accept="image/*" class="input" style="margin-bottom: 8px;">
          <div class="meta">이미지는 서버에 업로드되어 URL로 저장됩니다.</div>
        </div>
      </div>

      <!-- 기본 정보 -->
      <div class="row" style="margin-bottom: 8px;">
        <input id="name" class="input" placeholder="캐릭터 이름" style="flex: 1;">
        <input id="title" class="input" placeholder="칭호" style="flex: 1;">
      </div>
      
      <textarea id="desc" class="input" rows="4" placeholder="캐릭터 설명" style="margin-bottom: 16px;"></textarea>

      <!-- 스킬 정보 -->
      <h4>스킬 (최대 4개)</h4>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;" id="skills">
        <input id="a1n" class="input" placeholder="기술 1 이름">
        <input id="a1t" class="input" placeholder="기술 1 설명">
        <input id="a2n" class="input" placeholder="기술 2 이름">
        <input id="a2t" class="input" placeholder="기술 2 설명">
        <input id="a3n" class="input" placeholder="기술 3 이름">
        <input id="a3t" class="input" placeholder="기술 3 설명">
        <input id="a4n" class="input" placeholder="기술 4 이름">
        <input id="a4t" class="input" placeholder="기술 4 설명">
      </div>

      <div class="row" style="justify-content: flex-end;">
        <button id="save" class="btn primary">로스터에 추가</button>
      </div>
    </section>

    <aside class="card">
      <h3>도움말</h3>
      <div class="meta">
        <p><strong>이미지:</strong> JPG, PNG, GIF 등 이미지 파일을 업로드할 수 있습니다.</p>
        <p><strong>이름:</strong> 캐릭터의 고유한 이름을 입력하세요.</p>
        <p><strong>칭호:</strong> 캐릭터의 직업이나 별명을 입력하세요.</p>
        <p><strong>설명:</strong> 캐릭터의 배경이나 특징을 설명하세요.</p>
        <p><strong>스킬:</strong> 캐릭터가 사용할 수 있는 능력들을 정의하세요.</p>
      </div>
    </aside>
  </div>

  <script type="module">
    import { API } from '../core/api.js';
    import { Store } from '../core/store.js';

    const fileInput = document.getElementById('file');
    const preview = document.getElementById('preview');
    const placeholder = document.getElementById('placeholder');

    // 파일 선택 시 미리보기
    fileInput.addEventListener('change', () => {
      const file = fileInput.files?.[0];
      if (file) {
        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
      } else {
        preview.style.display = 'none';
        placeholder.style.display = 'block';
      }
    });

    // 저장 버튼 클릭
    document.getElementById('save').addEventListener('click', async () => {
      try {
        // 이미지 업로드
        let imageUrl = '';
        const file = fileInput.files?.[0];
        if (file) {
          const result = await API.upload(file);
          imageUrl = result.url;
        }

        // 캐릭터 데이터 생성
        const character = {
          id: 'char-' + (crypto.randomUUID?.() || Date.now()),
          name: getValue('name'),
          title: getValue('title'),
          desc: getValue('desc'),
          image: imageUrl,
          abilities: [1, 2, 3, 4].map(i => ({
            name: getValue('a' + i + 'n'),
            text: getValue('a' + i + 't')
          })).filter(ability => ability.name.trim()) // 빈 스킬 제거
        };

        // 유효성 검사
        if (!character.name.trim()) {
          alert('캐릭터 이름을 입력하세요.');
          return;
        }

        // 로스터에 추가
        Store.addChar(character);
        alert('캐릭터가 로스터에 추가되었습니다!');
        location.href = 'roster.html';
      } catch (error) {
        alert('캐릭터 생성 실패: ' + error.message);
      }
    });

    function getValue(id) {
      return (document.getElementById(id).value || '').trim();
    }
  </script>
</body>
</html>
