<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ë¡œë¹„ - Raid Starter Kit</title>
  <link rel="stylesheet" href="../styles/base.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="row" style="justify-content: space-between;">
        <div>
          <h1 style="margin: 0; font-size: 24px;">ğŸ° Raid Lobby</h1>
        </div>
        <div class="row">
          <input id="myName" class="input" style="max-width: 200px;" placeholder="í”Œë ˆì´ì–´ ì´ë¦„">
          <a href="character.html" class="btn">ìºë¦­í„° ìƒì„±</a>
          <a href="roster.html" class="btn">ë¡œìŠ¤í„°</a>
          <a href="prompt.html" class="btn">í”„ë¡¬í”„íŠ¸</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container grid" style="grid-template-columns: 1fr 400px;">
    <section class="card">
      <div class="row" style="justify-content: space-between;">
        <h3>ë°© ëª©ë¡</h3>
        <button id="mk" class="btn primary">ë°© ë§Œë“¤ê¸°</button>
      </div>
      <div id="rooms" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-top: 16px;"></div>
    </section>

    <aside class="card">
      <h3>ë¡œë¹„ ì±„íŒ…</h3>
      <div id="log" style="height: 300px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: #fafafa; margin-bottom: 8px;"></div>
      <div class="row">
        <input id="txt" class="input grow" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button id="send" class="btn primary">ì „ì†¡</button>
      </div>
    </aside>
  </div>

  <script type="module">
    import { Store } from '../core/store.js';
    import { API } from '../core/api.js';
    import { WS } from '../core/ws.js';

    const roomsBox = document.getElementById('rooms');
    const nameInput = document.getElementById('myName');
    const log = document.getElementById('log');
    const txt = document.getElementById('txt');

    // ì´ë¦„ ì„¤ì •
    nameInput.value = Store.state.name;
    nameInput.addEventListener('change', () => {
      Store.setName(nameInput.value.trim() || 'Player');
    });

    // ë°© ëª©ë¡ ë¡œë“œ
    async function loadRooms() {
      try {
        const { rooms } = await API.listRooms();
        roomsBox.innerHTML = rooms.map(room => `
          <div class="card">
            <h4>${room.title}</h4>
            <div class="meta">${room.players}/${room.max}ëª… Â· ${room.boss ? 'ë³´ìŠ¤ ìˆìŒ' : 'ë³´ìŠ¤ ì—†ìŒ'} Â· ${room.status}</div>
            <div class="row" style="margin-top: 8px;">
              <a class="btn primary" href="room.html?room=${room.id}">ì°¸ê°€í•˜ê¸°</a>
            </div>
          </div>
        `).join('') || '<div class="meta">ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      } catch (error) {
        console.error('ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        roomsBox.innerHTML = '<div class="meta">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
      }
    }

    // ë°© ë§Œë“¤ê¸°
    document.getElementById('mk').addEventListener('click', async () => {
      const title = prompt('ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ìƒˆ ë°©');
      if (title === null) return;

      const desc = prompt('ë°© ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
      const maxPlayers = parseInt(prompt('ìµœëŒ€ ì¸ì› (1-12):', '4') || '4');
      const openSlots = Array.from({ length: maxPlayers }, (_, i) => i + 1);

      try {
        const { room } = await API.createRoom({
          clientId: Store.state.clientId,
          title,
          desc,
          maxPlayers,
          openSlots
        });
        location.href = 'room.html?room=' + room.id;
      } catch (error) {
        alert('ë°© ìƒì„± ì‹¤íŒ¨: ' + error.message);
      }
    });

    // ì±„íŒ… ê¸°ëŠ¥
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    }

    function pushChat(name, text) {
      const div = document.createElement('div');
      div.style.marginBottom = '4px';
      div.innerHTML = `<b>${escapeHtml(name)}:</b> ${escapeHtml(text)}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function sendMessage() {
      const message = txt.value.trim();
      if (!message) return;
      
      txt.value = '';
      WS.chatSend(Store.state.clientId, 'general', Store.state.name, message);
    }

    document.getElementById('send').addEventListener('click', sendMessage);
    txt.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // WebSocket ì—°ê²°
    WS.connect();
    WS.on('LOBBY_STATE', (message) => {
      (message.chat || []).forEach(chat => pushChat(chat.name, chat.text));
    });
    WS.on('CHAT_PUSH', (message) => {
      if (message.message && message.message.roomId === 'lobby') {
        pushChat(message.message.name, message.message.text);
      }
    });

    // ì´ˆê¸°í™”
    WS.join('lobby', Store.state.clientId);
    loadRooms();
  </script>
</body>
</html>
